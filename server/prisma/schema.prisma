generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String           @id @default(cuid())
  email                 String           @unique
  passwordHash          String?
  name                  String?
  polarCustomerId       String?          @unique
  firebaseUid           String?          @unique
  authProvider          String           @default("legacy") // "legacy" | "firebase"
  totalProjectsCreated  Int              @default(0) // Track lifetime projects (even deleted)
  createdAt             DateTime         @default(now())
  unifiedProjects       UnifiedProject[]
  subscription          Subscription?
}

model Subscription {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id])
  polarSubscriptionId   String?  @unique
  plan                  Plan     @default(FREE)
  status                String   // active, canceled, past_due
  currentPeriodEnd      DateTime
}

enum Plan {
  FREE
  PRO
}

// Unified Project Model - combines all project types
model UnifiedProject {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  name            String
  mode            String   @default("wizard") // "wizard" | "manual"

  // App Info
  appName           String   @default("")
  briefDescription  String   @default("")
  targetKeywords    String   @default("")

  // Screenshots
  screenshots       UnifiedScreenshot[]
  styleConfig       Json?
  deviceSize        String   @default("6.9")

  // Metadata
  metadataPlatform       String   @default("ios")
  generatedMetadata      Json?
  editedMetadata         Json?
  metadataTranslations   Json?

  // Languages
  sourceLanguage    String   @default("en-US")
  targetLanguages   String[] @default([])
  translationData   Json?

  // Wizard State
  wizardCurrentStep        Int      @default(1)
  wizardTone               String   @default("bright")
  wizardLayoutPreset       String   @default("bottom")
  wizardSelectedTemplateId String?
  wizardGeneratedHeadlines Json?
  wizardEditedHeadlines    Json?
  wizardGeneratedIconUrl   String?
  wizardStatus             String   @default("draft")
  wizardUploadedScreenshots Json?
  wizardScreenshotEditorData Json?
  wizardTranslatedHeadlines  Json?
  wizardTranslatedEditorData Json?  // Per-language editor settings (mockupScale, positions, etc.)

  // Wizard service toggles
  wizardGenerateScreenshots Boolean  @default(true)
  wizardGenerateIcon        Boolean  @default(true)
  wizardGenerateMetadata    Boolean  @default(true)

  // Usage tracking
  generationCount Int      @default(0) // Track AI generations for limits

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model UnifiedScreenshot {
  id              String          @id @default(cuid())
  projectId       String
  project         UnifiedProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  order           Int
  imagePath       String?
  text            String          @default("")
  decorations     Json?
  styleOverride   Json?
  mockupSettings  Json?
}

// Admin-editable AI prompts
model AdminPrompt {
  id            String   @id @default(cuid())
  key           String   @unique
  name          String
  description   String?
  systemMessage String   @db.Text
  userTemplate  String   @db.Text
  model         String   @default("gpt-4o-mini")
  temperature   Float    @default(0.7)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Promo codes for subscriptions
model PromoCode {
  id              String    @id @default(cuid())
  code            String    @unique
  description     String?
  discountType    String    @default("percent") // "percent" | "fixed" | "free_trial"
  discountValue   Float     @default(0)         // percent (0-100) or fixed amount
  freeTrialDays   Int       @default(0)         // days of free PRO access
  maxUses         Int?                          // null = unlimited
  usedCount       Int       @default(0)
  validFrom       DateTime  @default(now())
  validUntil      DateTime?                     // null = no expiration
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  redemptions     PromoRedemption[]
}

// Track promo code redemptions
model PromoRedemption {
  id          String    @id @default(cuid())
  promoCodeId String
  promoCode   PromoCode @relation(fields: [promoCodeId], references: [id])
  userId      String
  redeemedAt  DateTime  @default(now())

  @@unique([promoCodeId, userId])
}

// AI usage logging for cost tracking
model AIUsageLog {
  id               String   @id @default(cuid())
  userId           String?
  projectId        String?
  operationType    String   // "headlines_generation", "metadata_generation", "translation", "icon_generation"
  model            String   // "gpt-4o-mini", "dall-e-3", etc.
  promptTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalTokens      Int      @default(0)
  estimatedCost    Float    @default(0) // in USD
  durationMs       Int      @default(0)
  success          Boolean  @default(true)
  errorMessage     String?
  metadata         Json?    // additional context (language, etc.)
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([operationType])
}
